{% extends "base.html" %}
{% block title %}ÄÄƒng kÃ½ tháº» xe{% endblock %}
{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-3">
  <div class="d-flex align-items-center gap-3">
    <div class="sb-ic" aria-hidden="true">ğŸªª</div>
    <div>
      <h2 class="mb-0">ÄÄƒng kÃ½ tháº» xe</h2>
      <div class="text-muted small">ÄÄƒng kÃ½ tháº» thÃ¡ng/quÃ½/nÄƒm vÃ  chá» admin xÃ¡c nháº­n thanh toÃ¡n Ä‘á»ƒ kÃ­ch hoáº¡t.</div>
    </div>
  </div>
  <a class="btn btn-outline-secondary" href="{{ url_for('cards') }}">Tháº» cá»§a tÃ´i</a>
</div>

<div class="row g-3">
  <div class="col-lg-6">
    <div class="sb-box">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div>
          <h5 class="mb-1">ThÃ´ng tin Ä‘Äƒng kÃ½</h5>
          <div class="text-muted small">Chá»§ tháº»: {{ khach_hang.hoTen or user.email }}</div>
        </div>
      </div>
      <form method="post">
        <div class="mb-3">
          <label class="form-label">Loáº¡i tháº»</label>
          <select class="form-select" name="loaiThe" required>
            <option value="THANG">ThÃ¡ng (30 ngÃ y)</option>
            <option value="QUY">QuÃ½ (90 ngÃ y)</option>
            <option value="NAM">NÄƒm (365 ngÃ y)</option>
          </select>
          <div class="form-text">GiÃ¡ tham kháº£o: thÃ¡ng {{ pricing.THANG|int }} Ä‘, quÃ½ {{ pricing.QUY|int }} Ä‘, nÄƒm {{ pricing.NAM|int }} Ä‘.</div>
        </div>

        <div class="mb-3">
          <label class="form-label">NgÃ y báº¯t Ä‘áº§u hiá»‡u lá»±c</label>
          <input type="date" name="ngayBatDau" class="form-control" value="{{ today_str }}" required>
          <div class="form-text">KhÃ´ng chá»n ngÃ y trong quÃ¡ khá»©.</div>
        </div>

        <div class="mb-3">
          <label class="form-label">HÃ¬nh thá»©c thanh toÃ¡n</label>
          <select class="form-select" name="payment_method">
            <option value="CASH">Tiá»n máº·t táº¡i quáº§y</option>
            <option value="BANK">Chuyá»ƒn khoáº£n</option>
            <option value="OTHER">KhÃ¡c</option>
          </select>
          <div class="form-text">Hiá»‡n táº¡i lÃ  thu tiá»n thá»§ cÃ´ng: admin sáº½ Ä‘Ã¡nh dáº¥u Ä‘Ã£ nháº­n tiá»n vÃ  kÃ­ch hoáº¡t tháº».</div>
        </div>

        <div class="mb-3">
          <label class="form-label">MÃ£ giao dá»‹ch / ná»™i dung chuyá»ƒn khoáº£n (náº¿u cÃ³)</label>
          <input type="text" class="form-control" name="payment_ref" placeholder="VÃ­ dá»¥: ND: SB-XXXX hoáº·c mÃ£ giao dá»‹ch ngÃ¢n hÃ ng">
        </div>

        <div class="mb-3">
          <label class="form-label">Link áº£nh biÃªn lai (tÃ¹y chá»n)</label>
          <input type="url" class="form-control" name="proof_url" placeholder="DÃ¡n link áº£nh biÃªn lai hoáº·c drive">
        </div>

        <div class="d-grid gap-2">
          <button type="submit" class="btn btn-success">ÄÄƒng kÃ½ tháº»</button>
          <div class="text-muted small">
            Tip: náº¿u chá»n chuyá»ƒn khoáº£n, hÃ£y Ä‘iá»n ná»™i dung/mÃ£ giao dá»‹ch Ä‘á»ƒ admin Ä‘á»‘i soÃ¡t nhanh.
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="sb-box">
      <h5 class="mb-2">Tháº» Ä‘Ã£ Ä‘Äƒng kÃ½</h5>
      {% if existing_cards %}
        <div class="list-group">
          {% for c in existing_cards %}
            <div class="list-group-item d-flex justify-content-between align-items-start flex-wrap gap-2">
              <div>
                <div class="fw-semibold">MÃ£ tháº»: {{ c.maSoThe }}</div>
                <div class="text-muted small">
                  Loáº¡i: {{ c.loaiThe or 'â€”' }} â€”
                  Hiá»‡u lá»±c: {{ c.ngayBatDau or 'â€”' }} â†’ {{ c.ngayHetHan or 'â€”' }}
                </div>
                <div class="text-muted small">
                  Thanh toÃ¡n: {{ c.payment_status or 'â€”' }}{% if c.payment_method %} ({{ c.payment_method }}){% endif %}
                </div>
              </div>
              <div class="d-flex flex-column align-items-end gap-1">
                <span class="badge text-bg-{{ 'success' if c.trangThai == 'KICH_HOAT' else 'warning' if c.trangThai == 'CHO_KICH_HOAT' else 'secondary' }}">
                  {{ c.trangThai or 'â€”' }}
                </span>
                {% set pay = (c.payment_status or '').upper() %}
                <span class="badge text-bg-{{ 'success' if pay == 'DA_THANH_TOAN' else 'warning' if pay == 'CHO_THANH_TOAN' else 'secondary' }}">
                  {{ c.payment_status or 'â€”' }}
                </span>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted">Báº¡n chÆ°a cÃ³ tháº» nÃ o.</div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
