{% extends "base.html" %}
{% block title %}Tuy·∫øn xe bu√Ωt{% endblock %}
{% block page_container_class %}container-fluid{% endblock %}

{% block content %}
<div class="py-4 px-3 sb-routes-wrap">
  <h1 class="text-center mb-4">Tuy·∫øn xe bu√Ωt (demo)</h1>

  <div class="sb-routes-grid">
    <!-- LEFT: danh s√°ch tuy·∫øn -->
    <div class="sb-routes-left">
      <div class="sb-box p-3 border rounded bg-white h-100 d-flex flex-column">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-bold">Danh s√°ch tuy·∫øn</div>
          <span class="badge text-bg-dark"><span id="routeCount">{{ routes|length }}</span> tuy·∫øn</span>
        </div>

        <div class="input-group input-group-sm mb-2">
          <span class="input-group-text">üîç</span>
          <input id="routeSearch" class="form-control" placeholder="T√¨m: 01, H·ªôi An, B·∫øn xe Trung t√¢m..." />
        </div>

        <select id="routeSelect" class="form-select form-select-sm mb-2">
          {% for r in routes %}
            <option value="{{ r.maTuyen }}">{{ r.maHienThi }} ‚Äî {{ r.tenTuyen or 'Ch∆∞a ƒë·∫∑t t√™n' }}</option>
          {% endfor %}
        </select>
        <div class="form-text mb-2"> H√£y ch·ªçn tuy·∫øn theo nhu c·∫ßu c·ªßa b·∫°n.</div>

        <div class="table-responsive sb-scroll-fill">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light" style="position: sticky; top: 0;">
              <tr>
                <th style="width: 90px;">M√£</th>
                <th>Tuy·∫øn</th>
              </tr>
            </thead>
            <tbody id="routeTableBody">
              {% for r in routes %}
              <tr class="route-row"
                  role="button"
                  data-route-id="{{ r.maTuyen }}"
                  data-code="{{ r.maHienThi }}"
                  data-name="{{ r.tenTuyen or '' }}"
                  data-start="{{ r.diemBatDau or '' }}"
                  data-end="{{ r.diemKetThuc or '' }}"
                  data-status=""
                  data-text="{{ (r.maHienThi ~ ' ' ~ (r.tenTuyen or '') ~ ' ' ~ (r.diemBatDau or '') ~ ' ' ~ (r.diemKetThuc or ''))|lower }}">
                <td class="fw-bold">{{ r.maHienThi }}</td>
                <td>
                  <div class="fw-semibold">{{ r.tenTuyen or "‚Äî" }}</div>
                  <div class="text-muted small">{{ r.diemBatDau or "‚Äî" }} ‚Üí {{ r.diemKetThuc or "‚Äî" }}</div>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="2" class="text-muted">Ch∆∞a c√≥ tuy·∫øn n√†o.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div id="emptyState" class="text-muted small mt-2 d-none">
          Kh√¥ng t√¨m th·∫•y tuy·∫øn ph√π h·ª£p. Th·ª≠ t·ª´ kho√° kh√°c.
        </div>
      </div>
    </div>

    <!-- MID: Overview map (selected route only) -->
    <div class="sb-routes-mid">
      <div class="sb-box sb-box--map h-100">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">B·∫£n ƒë·ªì t·ªïng quan</h5>
          <span class="text-muted small">Tuy·∫øn ƒëang ch·ªçn</span>
        </div>
        <div id="routes-overview-map" class="sb-map"></div>
        <div id="overviewMapStatus" class="alert alert-secondary py-2 px-3 mt-2 d-none"></div>
      </div>
    </div>

    <!-- RIGHT: Route KPI -->
    <div class="sb-routes-right">
      <div class="sb-box p-3 border rounded bg-white h-100 d-flex flex-column" id="routeSummaryPanel">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <div class="fw-bold" id="selectedRouteTitle">Ch∆∞a ch·ªçn tuy·∫øn</div>
            <div class="text-muted small" id="selectedRouteMeta">‚Äî</div>
          </div>
          <span id="kpiDataStatus" class="badge text-bg-secondary">‚Äî</span>
        </div>

        <div id="routeSummaryError" class="alert alert-warning py-2 px-3 d-none">Kh√¥ng t·∫£i ƒë∆∞·ª£c KPI tuy·∫øn.</div>

        <div class="row g-2 mb-3">
          <div class="col-6">
            <div class="border rounded p-2 h-100">
              <div class="text-muted small">L∆∞·ª£t ƒëi (DI)</div>
              <div class="fw-bold d-flex align-items-center gap-2">
                <span id="kpiStopsDI">0 tr·∫°m</span>
                <span class="badge text-bg-success" id="badgeDI">OK</span>
              </div>
              <div class="text-muted small" id="kpiStopsDIGeo">‚Äî t·ªça ƒë·ªô</div>
            </div>
          </div>
          <div class="col-6">
            <div class="border rounded p-2 h-100">
              <div class="text-muted small">L∆∞·ª£t v·ªÅ (VE)</div>
              <div class="fw-bold d-flex align-items-center gap-2">
                <span id="kpiStopsVE">0 tr·∫°m</span>
                <span class="badge text-bg-success" id="badgeVE">OK</span>
              </div>
              <div class="text-muted small" id="kpiStopsVEGeo">‚Äî t·ªça ƒë·ªô</div>
            </div>
          </div>
          <div class="col-12">
            <div class="border rounded p-2">
              <div class="text-muted small">T·ª∑ l·ªá tr·∫°m c√≥ t·ªça ƒë·ªô</div>
              <div class="fw-bold" id="kpiGeoPercent">0%</div>
            </div>
          </div>
        </div>

        <div class="border rounded p-2 mb-3">
          <div class="fw-semibold mb-1">Th√¥ng tin tuy·∫øn</div>
          <div class="small text-muted">Kho·∫£ng c√°ch: <span id="routeDistance">‚Äî</span></div>
          <div class="small text-muted">Th·ªùi gian ho·∫°t ƒë·ªông: <span id="routeHours">‚Äî</span></div>
          <div class="small text-muted">T·∫ßn su·∫•t: <span id="routeFreq">‚Äî</span></div>
          <div class="small text-muted">Gi√° v√©: <span id="routeFare">‚Äî</span></div>
        </div>

        <div class="mt-3">
          <a id="btnRouteDetail" class="btn btn-primary w-100 mb-2 disabled" href="#">Xem chi ti·∫øt tuy·∫øn</a>
          <a class="btn btn-outline-secondary w-100" href="{{ url_for('home') }}">V·ªÅ trang ch·ªß</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  window.__initialRouteId = {{ initial_route_id|default('null') }};
</script>

<script src="{{ static_url('js/routes_overview_map.js') }}"></script>
<script src="{{ static_url('js/routes_dashboard.js') }}"></script>
{% endblock %}
