{% extends "base.html" %}
{% block title %}Tuyến xe buýt{% endblock %}

{% block content %}
<div class="container py-4">
  <h1 class="text-center mb-4">Tuyến xe buýt (demo)</h1>

  <div class="row g-3">
    <!-- LEFT: danh sách tuyến -->
    <div class="col-lg-4">
      <div class="sb-box p-3 border rounded bg-white">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-bold">Danh sách tuyến</div>
          <span class="badge text-bg-dark"><span id="routeCount">{{ routes|length }}</span> tuyến</span>
        </div>

        <input id="routeSearch" class="form-control form-control-sm mb-2" placeholder="Tìm: 01, Hội An, Bến xe Trung tâm..." />

        <!-- Có thể giữ hoặc bỏ select này; JS vẫn chạy -->
        <select id="routeSelect" class="form-select form-select-sm mb-2">
          {% for r in routes %}
            <option value="{{ r.maTuyen }}">{{ r.maHienThi }} — {{ r.tenTuyen or 'Chưa đặt tên' }}</option>
          {% endfor %}
        </select>
        <div class="form-text mb-2">Tip: Bạn có thể click trực tiếp dòng trong bảng bên dưới.</div>

        <div class="table-responsive" style="max-height: 430px; overflow:auto;">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light" style="position: sticky; top: 0;">
              <tr>
                <th style="width: 90px;">Mã</th>
                <th>Tuyến</th>
              </tr>
            </thead>
            <tbody id="routeTableBody">
              {% for r in routes %}
              <tr class="route-row"
                  role="button"
                  data-route-id="{{ r.maTuyen }}"
                  data-code="{{ r.maHienThi }}"
                  data-name="{{ r.tenTuyen or '' }}"
                  data-start="{{ r.diemBatDau or '' }}"
                  data-end="{{ r.diemKetThuc or '' }}"
                  data-text="{{ (r.maHienThi ~ ' ' ~ (r.tenTuyen or '') ~ ' ' ~ (r.diemBatDau or '') ~ ' ' ~ (r.diemKetThuc or ''))|lower }}">
                <td class="fw-bold">{{ r.maHienThi }}</td>
                <td>
                  <div class="fw-semibold">{{ r.tenTuyen or "—" }}</div>
                  <div class="text-muted small">{{ r.diemBatDau or "—" }} → {{ r.diemKetThuc or "—" }}</div>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="2" class="text-muted">Chưa có tuyến nào.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div id="emptyState" class="text-muted small mt-2 d-none">
          Không tìm thấy tuyến phù hợp. Thử từ khoá khác.
        </div>
      </div>
    </div>

    <!-- MID: map -->
    <div class="col-lg-5">
      <div class="sb-box p-3 border rounded bg-white">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-bold">Bản đồ tuyến</div>
          <div class="text-muted small">* Vẽ theo trạm có tọa độ</div>
        </div>
        <div id="routes-map" class="border rounded" style="height: 560px; overflow:hidden;"></div>
      </div>
    </div>

    <!-- RIGHT: info -->
    <div class="col-lg-3">
      <div class="sb-box p-3 border rounded bg-white">
        <div class="fw-bold mb-1" id="selectedRouteTitle">Chưa chọn tuyến</div>
        <div class="text-muted small mb-3" id="selectedRouteMeta">—</div>

        <div class="row g-2 mb-3">
          <div class="col-6">
            <div class="border rounded p-2">
              <div class="text-muted small">Số trạm</div>
              <div class="fw-bold" id="kpiStops">0</div>
            </div>
          </div>
          <div class="col-6">
            <div class="border rounded p-2">
              <div class="text-muted small">Marker hợp lệ</div>
              <div class="fw-bold" id="kpiMarkers">0</div>
            </div>
          </div>
          <div class="col-6">
            <div class="border rounded p-2">
              <div class="text-muted small">Vẽ tuyến</div>
              <div class="fw-bold" id="kpiLine">—</div>
            </div>
          </div>
          <div class="col-6">
            <div class="border rounded p-2">
              <div class="text-muted small">Dữ liệu map</div>
              <div class="fw-bold" id="kpiMapData">—</div>
            </div>
          </div>
        </div>

        <a id="btnRouteDetail" class="btn btn-primary w-100 mb-2 disabled" href="#">Xem chi tiết tuyến</a>
        <a class="btn btn-outline-secondary w-100" href="{{ url_for('home') }}">Về trang chủ</a>

        <hr>

        <div class="fw-bold mb-2">Danh sách trạm</div>
        <ul id="stopList" class="list-unstyled mb-0" style="max-height: 240px; overflow:auto;">
          <li class="text-muted">Chọn tuyến bên trái.</li>
        </ul>

        <div class="text-muted small mt-2">
          “Marker hợp lệ” = trạm có lat/lng. Nếu &lt; 2 thì không thể vẽ tuyến.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet (nếu base.html của bạn chưa có) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="{{ url_for('static', filename='js/maps_osrm.js') }}"></script>
<script src="{{ url_for('static', filename='js/routes_dashboard.js') }}"></script>
{% endblock %}
