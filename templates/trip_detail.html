{% extends "base.html" %}
{% block title %}Chuyến #{{ trip.maChuyen }}{% endblock %}

{% block content %}
{% if is_admin_mode %}
  <a href="{{ url_for('admin_route_trips', tuyen_id=trip.tuyen_id) }}"
     class="btn btn-outline-secondary mb-3">
    &laquo; Quay lại quản lý chuyến
  </a>
{% else %}
  <a href="{{ url_for('route_detail', tuyen_id=trip.tuyen_id) }}"
     class="btn btn-dark mb-3">
    &laquo; Quay lại tuyến đang xem
  </a>
{% endif %}

<div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
  <div>
    <h2 class="mb-1">Chuyến #{{ trip.maChuyen }}</h2>
    <div class="text-muted">
      Tuyến <b>{{ tuyen.maHienThi }}</b> — {{ tuyen.tenTuyen or "—" }}<br>
      {{ tuyen.diemBatDau or "—" }} → {{ tuyen.diemKetThuc or "—" }}
      </div>
    </div>

    <div class="text-end">
      <div class="text-muted small">Ngày / giờ khởi hành</div>
      <div class="fw-semibold">
        {{ trip.ngayKhoiHanh }} — {{ trip.gioKhoiHanh }}
        <span class="badge text-bg-light ms-2">{{ direction }}</span>
        {% if is_past_trip %}<span class="badge text-bg-secondary ms-2">Đã khởi hành</span>{% endif %}
      </div>
    </div>
  </div>

{% set dir_label = 'Lượt đi' if direction == 'DI' else 'Lượt về' %}

<div class="row g-3 mt-2 sb-trip-panels">
  <div class="col-lg-7">
    <div class="sb-box sb-box--map sb-trip-panel">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Bản đồ trạm</h5>
        <span class="badge text-bg-light">{{ direction }} ({{ dir_label }})</span>
      </div>
      <div class="sb-trip-panel-body">
        <div id="trip-map" class="sb-map sb-map--fill"></div>
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="sb-box sb-trip-panel d-flex flex-column">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Danh sách trạm</h5>
        <span class="badge text-bg-{{ 'success' if direction == 'DI' else 'secondary' }}">{{ direction }}</span>
      </div>

      {% if stop_times %}
        <div class="text-muted small mb-2">
          Giờ đến trạm <b>dự kiến</b> (ước tính), có thể sai lệch vì không có GPS realtime.
        </div>
      {% endif %}

      <div class="sb-stop-list sb-stop-list--fill">
        <ul class="sb-stop-ul mb-0">
          {% if stop_times %}
            {% for row in stop_times %}
              {% set s = row.stop %}
              <li class="sb-stop-item sb-stop-item--click js-stop-zoom"
                  data-lat="{{ s.lat }}" data-lng="{{ s.lng }}">
                <div class="d-flex justify-content-between align-items-start gap-2">
                  <div class="fw-semibold">
                    <span class="badge text-bg-light me-2">{{ direction }}</span>
                    {{ s.thuTuTrenTuyen }}. {{ s.tenTram }}
                  </div>
                  <div class="d-flex align-items-center gap-2 flex-shrink-0">
                    <a class="badge text-bg-light text-decoration-none"
                       href="{{ url_for('stop_detail', stop_id=s.maTram) }}">
                      Chi tiết trạm
                    </a>
                    {% if row.eta_time %}
                      <span class="badge text-bg-light">{{ row.eta_time }}</span>
                    {% else %}
                      <span class="badge text-bg-secondary">—</span>
                    {% endif %}
                  </div>
                </div>
                {% if s.diaChi %}<div class="text-muted small">{{ s.diaChi }}</div>{% endif %}
                {% if row.offset_min is not none %}
                  <div class="text-muted small">+{{ row.offset_min }} phút{% if row.distance_km is not none %} • {{ row.distance_km }} km{% endif %}</div>
                {% endif %}
              </li>
            {% endfor %}
          {% else %}
            {% for s in stops %}
            <li class="sb-stop-item sb-stop-item--click js-stop-zoom"
                data-lat="{{ s.lat }}" data-lng="{{ s.lng }}">
              <div class="d-flex justify-content-between align-items-start gap-2">
                <div class="fw-semibold">
                  <span class="badge text-bg-light me-2">{{ direction }}</span>
                  {{ s.thuTuTrenTuyen }}. {{ s.tenTram }}
                </div>
                <a class="badge text-bg-light text-decoration-none"
                   href="{{ url_for('stop_detail', stop_id=s.maTram) }}">
                  Chi tiết trạm
                </a>
              </div>
              {% if s.diaChi %}<div class="text-muted small">{{ s.diaChi }}</div>{% endif %}
            </li>
            {% else %}
              <li class="text-muted">Tuyến này chưa có danh sách trạm dừng.</li>
            {% endfor %}
          {% endif %}
        </ul>
      </div>

      <div class="mt-3">
        <div class="alert alert-light border mb-0">
          Bus đô thị: không đặt/mua vé trên web. Thanh toán trên xe hoặc sử dụng thẻ (vé tháng/quý/năm).
        </div>
      </div>
    </div>
  </div>
</div>

<script src="{{ static_url('js/maps_osrm.js') }}"></script>
<script>
  document.addEventListener("DOMContentLoaded", async function () {
    const stops = {{ stops_geo|tojson|safe }};
    if (typeof renderStopsMap === "function") await renderStopsMap(stops, "trip-map");

    document.querySelectorAll(".js-stop-zoom").forEach((el) => {
      const lat = Number(el.dataset.lat);
      const lng = Number(el.dataset.lng);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
      el.addEventListener("click", (e) => {
        if (e?.target?.closest?.("a")) return;
        if (typeof focusStopOnMap === "function") focusStopOnMap("trip-map", lat, lng, 16);
      });
    });
  });
</script>
{% endblock %}
