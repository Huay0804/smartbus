{% extends "base.html" %}
{% block title %}Đặt vé chuyến #{{ trip.maChuyen }}{% endblock %}

{% block content %}
<h2>Đặt vé cho chuyến #{{ trip.maChuyen }}</h2>

<p>
  Tuyến {{ tuyen.maHienThi }} – {{ tuyen.tenTuyen }}<br>
  {{ tuyen.diemBatDau }} → {{ tuyen.diemKetThuc }}<br>
  Ngày: {{ trip.ngayKhoiHanh }} – Giờ: {{ trip.gioKhoiHanh }}
</p>

<form method="post">
  <input type="hidden" name="soGhe" id="seat-input">
  <input type="hidden" name="giaVe" value="{{ gia_mac_dinh }}">

  <div class="row">
    <!-- Cột chọn ghế -->
    <div class="col-md-4 mb-4">
      <h5>Chọn ghế</h5>
      <p class="text-muted small">
        Bấm vào một ghế trống để chọn. Ghế xám là ghế đã có người đặt.
      </p>

      <div class="seat-grid">
        {% for i in range(1, seat_capacity + 1) %}
          {% set ghe = "%02d" % i %}
          {% if ghe in booked_seats %}
            <button type="button"
                    class="seat btn btn-sm btn-secondary mb-1 me-1"
                    disabled>
              {{ ghe }}
            </button>
          {% else %}
            <button type="button"
                    class="seat btn btn-sm btn-outline-primary mb-1 me-1"
                    data-seat="{{ ghe }}">
              {{ ghe }}
            </button>
          {% endif %}

          {% if i % 4 == 0 %}
            <div class="w-100"></div>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <!-- Cột thông tin vé -->
    <div class="col-md-4 mb-4">
      <h5>Thông tin vé</h5>

      <div class="mb-3">
        <label class="form-label">Ghế đã chọn</label>
        <input type="text" class="form-control" id="seat-display" readonly>
      </div>

      <div class="mb-3">
        <label class="form-label">Giá vé</label>
        <input type="text" class="form-control"
               value="{{ "{:,.0f}".format(gia_mac_dinh) }} đ" readonly>
      </div>

      <button type="submit" class="btn btn-primary">
        Xác nhận đặt vé
      </button>
      <a href="{{ url_for('trip_detail', trip_id=trip.maChuyen) }}"
         class="btn btn-link">
        Quay lại chi tiết chuyến
      </a>
    </div>
  </div>
</form>

<script>
  const seatButtons = document.querySelectorAll('.seat[data-seat]');
  const seatInput   = document.getElementById('seat-input');
  const seatDisplay = document.getElementById('seat-display');

  // tập ghế đang chọn
  const selected = new Set();

  function updateSeats() {
    const arr = Array.from(selected).sort();
    seatInput.value   = arr.join(",");
    seatDisplay.value = arr.join(", ");
  }

  seatButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const seat = btn.dataset.seat;
      if (selected.has(seat)) {
        // bấm lần nữa -> bỏ chọn
        selected.delete(seat);
        btn.classList.remove('active');
      } else {
        // chọn thêm ghế
        selected.add(seat);
        btn.classList.add('active');
      }
      updateSeats();
    });
  });
</script>

{% endblock %}
