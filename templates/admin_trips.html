{% extends "base.html" %} 
{% block title %}Quản lý chuyến - {{ tuyen.maHienThi }}{% endblock %}

{% block content %}
<a href="{{ url_for('admin_routes') }}" class="btn btn-outline-secondary mb-3">
  &laquo; Quay lại quản lý tuyến
</a>

<h2>Quản lý chuyến – Tuyến {{ tuyen.maHienThi }} - {{ tuyen.tenTuyen }}</h2>
<p class="text-muted">
  Điểm bắt đầu: {{ tuyen.diemBatDau }} –
  Điểm kết thúc: {{ tuyen.diemKetThuc }}
</p>

<div class="row">
  <!-- Cột trái: quản lý chuyến -->
  <div class="col-lg-5 mb-4">
    <h5>Danh sách chuyến xe</h5>

    <form class="row g-2 mb-3" method="post">
      <div class="col-6">
        <input type="date" name="ngayKhoiHanh" class="form-control">
      </div>
      <div class="col-4">
        <input type="time" name="gioKhoiHanh" class="form-control">
      </div>
      <div class="col-2 d-grid">
        <button class="btn btn-primary">Thêm chuyến</button>
      </div>
    </form>

    <table class="table table-sm table-hover align-middle">
      <thead>
        <tr>
          <th>Mã</th>
          <th>Ngày</th>
          <th>Giờ</th>
          <th style="width: 180px;">Hành động</th>
        </tr>
      </thead>
      <tbody>
        {% for trip in trips %}
        <tr>
          <td>{{ trip.maChuyen }}</td>
          <td>{{ trip.ngayKhoiHanh }}</td>
          <td>{{ trip.gioKhoiHanh }}</td>
          <td>
            <!-- Xem chi tiết ở chế độ admin: thêm mode=admin -->
            <a class="btn btn-sm btn-outline-primary me-1"
               href="{{ url_for('trip_detail', trip_id=trip.maChuyen, mode='admin') }}">
              Xem chi tiết
            </a>

            <!-- Nút xóa chuyến -->
            <form method="post"
                  action="{{ url_for('delete_trip', trip_id=trip.maChuyen) }}"
                  class="d-inline"
                  onsubmit="return confirm('Bạn chắc chắn muốn xóa chuyến #{{ trip.maChuyen }}?');">
              <button class="btn btn-sm btn-outline-danger">
                Xóa
              </button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="4" class="text-center text-muted">
            Chưa có chuyến nào cho tuyến này.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Cột phải: trạm + map -->
  <div class="col-lg-7">
    <h5>Trạm dừng (chỉ hiển thị)</h5>
    <p class="text-muted">
      Để thêm / xóa trạm dừng, vào Admin &rarr; Quản lý trạm.
    </p>

    <table class="table table-sm table-hover align-middle mb-3">
      <thead>
        <tr>
          <th>#</th>
          <th>Tên trạm</th>
          <th>Địa chỉ</th>
        </tr>
      </thead>
      <tbody>
        {% for tram in stops %}
        <tr>
          <td>{{ tram.thuTuTrenTuyen }}</td>
          <td>{{ tram.tenTram }}</td>
          <td>{{ tram.diaChi }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="3" class="text-center text-muted">
            Chưa có trạm dừng nào cho tuyến này.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- MAP -->
    <div id="admin-trips-map"
         class="border rounded bg-light-subtle"
         style="height: 320px; overflow: hidden;"></div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const stops = {{ stops_geo|tojson|safe }};
    renderRouteMap(stops, "admin-trips-map");
  });
</script>
{% endblock %}
