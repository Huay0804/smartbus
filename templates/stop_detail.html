{% extends "base.html" %}
{% block title %}Trạm {{ stop.tenTram }}{% endblock %}

{% block content %}
{% set dir_label = 'Lượt đi' if direction == 'DI' else 'Lượt về' %}

<div class="container py-4">
  <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-3">
    <div>
      <div class="small text-muted">Chi tiết trạm</div>
      <h2 class="mt-1 mb-1">{{ stop.tenTram }}</h2>
      <div class="text-muted">{{ stop.diaChi or "—" }}</div>
      <div class="text-muted small mt-1">
        Tuyến <b>{{ tuyen.maHienThi }}</b> — {{ tuyen.tenTuyen or "—" }}
        <span class="mx-1">•</span>
        <span class="badge text-bg-{{ 'success' if direction == 'DI' else 'secondary' }}">{{ direction }}</span>
        <span class="text-muted">{{ dir_label }}</span>
        <span class="mx-1">•</span>
        Thứ tự: <b>{{ stop.thuTuTrenTuyen }}</b>
      </div>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-dark" href="{{ url_for('route_detail', tuyen_id=tuyen.maTuyen) }}">Quay lại tuyến đang xem</a>
      <a class="btn btn-outline-secondary" href="{{ url_for('routes') }}">Danh sách tuyến</a>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-7">
      <div class="sb-box sb-box--map h-100">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Bản đồ trạm</h5>
        </div>
        <div id="stop-map" class="sb-map" style="min-height: 420px;"></div>
        <div class="text-muted small mt-2">
          {% if offset_ok %}
            ETA ước tính theo lịch + khoảng cách ({{ offset_source or 'fallback' }}), không phải realtime GPS.
          {% else %}
            Chưa đủ dữ liệu để ước tính ETA cho trạm này.
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="sb-box d-flex flex-column">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Chuyến sẽ đi qua trạm</h5>
          <span class="badge text-bg-light">{{ upcoming|length }}</span>
        </div>

        {% if not upcoming %}
          <div class="text-muted small">Chưa có chuyến sắp tới (hoặc tuyến chưa có khung giờ/tần suất).</div>
        {% endif %}

        <div class="sb-stop-scroll">
          <div class="list-group list-group-flush">
            {% for t in upcoming %}
              <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-start gap-2"
                 href="{{ t.detail_url }}">
                <div>
                  <div class="fw-semibold">{{ t.eta_time }}</div>
                  <div class="text-muted small">
                    {{ t.date }} • {{ t.direction }} • Chuyến #{{ t.trip_id }}
                    {% if t.depart_time %}• Xuất bến {{ t.depart_time }}{% endif %}
                  </div>
                </div>
                <span class="badge text-bg-light">{{ t.eta_in_min }}p</span>
              </a>
            {% endfor %}
          </div>
        </div>

        <div class="mt-3">
          <div class="alert alert-light border mb-0">
            Gợi ý: Bấm vào một chuyến để xem toàn bộ danh sách trạm mà chuyến đi qua và giờ dự kiến chuyến sẽ đến.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="{{ static_url('js/maps_osrm.js') }}"></script>
<script>
  document.addEventListener("DOMContentLoaded", async function () {
    const stop = {{ stop_geo|tojson|safe }};
    const stops = [stop].filter((s) => s && s.lat != null && s.lng != null);
    if (typeof renderStopsMap === "function") await renderStopsMap(stops, "stop-map");
    if (stops.length && typeof focusStopOnMap === "function") {
      focusStopOnMap("stop-map", Number(stop.lat), Number(stop.lng), 16);
    }
  });
</script>
{% endblock %}
